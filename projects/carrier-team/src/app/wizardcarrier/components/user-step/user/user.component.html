<div
  class="toast"
  *ngIf="toastVisible"
  [ngClass]="{
    visible: toastVisible,
    'toast-success': toastType === 'success',
    'toast-error': toastType === 'error',
    'toast-warning': toastType === 'warning'
  }"
>
  <div class="toast-content">
    <span class="toast-message">{{ toastMessage }}</span>
    <button class="close-toast" (click)="hideToast()">Ã—</button>
  </div>
</div>

<div *ngIf="isLoading" class="loading-container">
  <p>Loading tickets...</p>
</div>

<div class="row">
  <div class="col-md-12 mb-3">
    <div *ngIf="!isLoading && assignedTickets.length > 0">
      <p class="lead">Assigned Tickets</p>
      <div class="ticket-summary-container">
        <div class="ticket-summary-card">
          <span class="summary-title">Tier 1</span>
          <span class="summary-value">{{ tier1Tickets }}</span>
        </div>
        <div class="ticket-summary-card">
          <span class="summary-title">Tier 2</span>
          <span class="summary-value">{{ tier2Tickets }}</span>
        </div>
        <div class="ticket-summary-card">
          <span class="summary-title">Tier 3</span>
          <span class="summary-value">{{ tier3Tickets }}</span>
        </div>
        <div class="ticket-summary-card">
          <span class="summary-title">Total Tickets</span>
          <span class="summary-value">{{ zendeskTicketCount }}</span>
        </div>
        <div class="ticket-summary-card">
          <span class="summary-title">Tickets to be Answered</span>
          <span class="summary-value">{{ ticketsToBeAnsweredCount }}</span>
        </div>
      </div>

      <div class="form-row mt-3">
        <div class="form-group col-sm-6 col-xl-3">
          <select id="sort-select" (change)="onSortChange($event)" class="form-control">
            <option value="">-- Select sorting --</option>
            <option value="priority:asc">Priority (ascending)</option>
            <option value="priority:desc">Priority (descending)</option>
            <option value="tier:asc">Tier (ascending)</option>
            <option value="tier:desc">Tier (descending)</option>
            <option value="updated_at:asc">Updated At (ascending)</option>
            <option value="updated_at:desc">Updated At (descending)</option>
            <option value="eta:asc">ETA (ascending)</option>
            <option value="eta:desc">ETA (descending)</option>
            <option value="toBeAnswered:asc">To Be Answered (ascending)</option>
            <option value="toBeAnswered:desc">To Be Answered (descending)</option>
          </select>
        </div>
        <div class="form-group col-sm-6 col-xl-3">
          <button class="btn btn-info btn-md" (click)="toggleAllJiraSections()">
            {{ allExpanded ? 'Collapse All JIRA' : 'Expand All Jira' }}
          </button>
        </div>
      </div>

      <div class="ticket-container">
        <div *ngFor="let ticket of assignedTickets; let i = index" class="ticket-card">
          <div class="ticket-header">
            <div class="ticket-id">
              <span class="id-label">Ticket ID:</span>
              <a
                [href]="'https://nshift.zendesk.com/agent/tickets/' + ticket.ticket_id"
                target="_blank"
                class="id-value"
                style="color: #0116a3;"
              >
                {{ ticket.ticket_id }}
              </a>
            </div>

            <div class="ticket-badges">
              <!-- Dynamically styled badge -->
              <span
                class="badge badge-close"
                [ngClass]="{
                  'bg-danger': ticket.priority === 'urgent',
                  'bg-warning': ticket.priority === 'high',
                  'bg-success': ticket.priority === 'normal',
                  'bg-primary': ticket.priority === 'low'
                }"
              >
                {{ ticket.priority | uppercase }}
              </span>

              <!-- Additional badges -->
              <span
                *ngIf="isToBeAnswered(ticket.updated_at)"
                class="badge badge-warning badge-close"
                style="background-color: #ff9800;"
              >
                Update Needed
              </span>

              <span
                class="badge badge-info badge-close"
                [ngClass]="{
                  'bg-info': ticket.customStatus === 'Assigned',
                  'bg-warning': ticket.customStatus === 'Pending Customer',
                  'bg-secondary': ticket.customStatus.startsWith('Awaiting')
                }"
              >
                {{ ticket.customStatus }}
              </span>
            </div>
          </div>

          <div class="ticket-body">
            <p class="ticket-subject">{{ ticket.subject }}</p>
            <div class="ticket-details">
              <p><strong>Created At:</strong> {{ ticket.created_at | date: 'MMMM d, y' }}</p>
              <p><strong>Updated At:</strong> {{ ticket.updated_at | date: 'MMMM d, y' }}</p>
              <p><strong>Tier:</strong> {{ ticket.tier }}</p>
              <p><strong>Carrier ID:</strong> {{ ticket.carrier_id }}</p>
              <p><strong>ETA:</strong> {{ ticket.eta ? (ticket.eta | date: 'MMMM d, y') : 'N/A' }}</p>
            </div>
          </div>
          <div class="ticket-footer">
            <button style="margin-right: 5%" class="btn btn-primary btn-sm" (click)="openModal(ticket)">
              Update
            </button>

            <ng-container *ngIf="ticket.jiraData?.length > 0; else noJira">
              <button class="btn btn-info btn-sm" (click)="toggleJiraVisibility(i)">
                {{ jiraVisibility[i] ? 'Hide JIRA Tickets' : 'JIRA Tickets' }}
              </button>
            </ng-container>

            <ng-template #noJira>
              <button class="btn btn-info btn-sm" disabled>
                No Jira added
              </button>
            </ng-template>

            <div style="margin-top: 4%" *ngIf="jiraVisibility[i] && ticket.jiraData?.length > 0">
              <ul class="jira-list">
                <li *ngFor="let jira of ticket.jiraData" class="jira-item">
                  <div class="jira-header">
                    <a
                      [href]="'https://nshiftgroup.atlassian.net/browse/' + jira.ticket"
                      target="_blank"
                      class="jira-link"
                    >
                      {{ jira.ticket }}
                    </a>
                    <span
                      class="jira-status"
                      [ngClass]="{
                        'status-resolved': jira.sprints.ticketStatus === 'Resolved',
                        'status-open': jira.sprints.ticketStatus === 'Open',
                        'status-closed': jira.sprints.ticketStatus === 'Closed',
                        'status-draft': jira.sprints.ticketStatus === 'Draft',
                        'status-testing': jira.sprints.ticketStatus === 'Testing',
                        'status-verified': jira.sprints.ticketStatus === 'Verified Fix'
                      }"
                    >
                      - Status: {{ jira.sprints.ticketStatus }}
                    </span>
                  </div>
                  <!-- Jira details -->
                  <div *ngIf="jira.sprints.currentSprint" class="jira-details">
                    <p><strong>Sprint:</strong> {{ jira.sprints.currentSprint.name }}</p>
                    <p><strong>Start:</strong> {{ jira.sprints.currentSprint.startDate | date: 'MMMM d, y' }}</p>
                    <p><strong>End:</strong> {{ jira.sprints.currentSprint.endDate | date: 'MMMM d, y' }}</p>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="customModal" tabindex="-1" role="dialog" aria-labelledby="customModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update ETA for Ticket {{ selectedTicket?.ticket_id }}</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Subject:</strong> {{ selectedTicket?.subject }}</p>

        <!-- Text area to write the message -->
        <div class="form-group">
          <div class="form-group">
            <label>
              <input type="checkbox" [(ngModel)]="ShouldBeInternal" />
              Send as Internal
            </label>
          </div>
          <label for="customMessage">Message to Customer:</label>
          <textarea id="customMessage" class="form-control" rows="3" [(ngModel)]="customMessage"></textarea>
        </div>

        <div class="form-group">
          <label for="newETA">New ETA:</label>
          <input
            id="newETA"
            type="date"
            class="form-control"
            [(ngModel)]="newETA"
            (change)="onETAChange($event)"
            [ngClass]="{ 'is-invalid': !newETA }"
          />
          <div *ngIf="!newETA" class="invalid-feedback">
            Please provide a valid date.
          </div>
        </div>

        <!-- Predefined message options -->
        <div class="form-group">
          <label for="messageTemplates">Select a predefined message:</label>
          <select id="messageTemplates" class="form-control" (change)="onTemplateSelect($event)" [disabled]="!newETA">
            <option value="">-- Select a message --</option>
            <option *ngFor="let template of messageTemplates" [value]="template.value">
              {{ template.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="includeRequesterName"
              (change)="updateEmailText()"
              [disabled]="!newETA"
            />
            Include Requester Name
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Close</button>
        <button class="btn btn-primary" (click)="sendETAUpdate()">Send Update</button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoading && assignedTickets.length === 0">
  <p>No tickets assigned.</p>
</div>
